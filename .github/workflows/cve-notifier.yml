name: Vuln Tower

on:
  schedule:
    # Run every hour
    - cron: "0 * * * *"

  workflow_dispatch:
    inputs:
      log_level:
        description: "Log level"
        required: false
        default: "INFO"
        type: choice
        options:
          - DEBUG
          - INFO
          - WARNING
          - ERROR

jobs:
  notify-cves:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Vuln Tower
        env:
          # General Configuration
          APP_NAME: vuln-tower
          LOG_LEVEL: ${{ github.event.inputs.log_level || 'INFO' }}
          RUN_MODE: ci

          # Database Configuration
          DB_TYPE: sqlite
          DB_NAME: vuln_tower.db

          # NVD Configuration
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
          FETCH_WINDOW_MINUTES: 60
          MAX_RESULTS_PER_RUN: 100
          REQUEST_TIMEOUT: 30

          # Filter Configuration
          MIN_CVSS_SCORE: 7.0
          KEYWORDS: ${{ vars.CVE_KEYWORDS || '' }}
          PRODUCTS: ${{ vars.CVE_PRODUCTS || '' }}
          VENDORS: ${{ vars.CVE_VENDORS || '' }}
          ATTACK_VECTOR: ${{ vars.CVE_ATTACK_VECTOR || '' }}

          # Notification Configuration - Discord
          ENABLE_DISCORD: ${{ vars.ENABLE_DISCORD || 'false' }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

          # Notification Configuration - Slack
          ENABLE_SLACK: ${{ vars.ENABLE_SLACK || 'false' }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

          # Notification Configuration - Teams
          ENABLE_TEAMS: ${{ vars.ENABLE_TEAMS || 'false' }}
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}

          # Notification Configuration - Telegram
          ENABLE_TELEGRAM: ${{ vars.ENABLE_TELEGRAM || 'false' }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

          # Pipeline Configuration (optional)
          ENABLE_PIPELINE: ${{ vars.ENABLE_PIPELINE || 'false' }}
          PIPELINE_STEPS: ${{ vars.PIPELINE_STEPS || '' }}
          LLM_PROVIDER: openai
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_MODEL: ${{ vars.LLM_MODEL || 'gpt-4o-mini' }}

          # Secret Provider (use env if secrets unavailable)
          SECRET_PROVIDER: ${{ vars.SECRET_PROVIDER || 'env' }}

        run: |
          python -m vuln_tower.main

      - name: Upload database artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vuln-tower-database-${{ github.run_number }}
          path: vuln_tower.db
          retention-days: 30

      - name: Notify on failure
        if: failure()
        run: |
          echo "Vuln Tower execution failed"
          # Add additional failure notification logic here if needed
